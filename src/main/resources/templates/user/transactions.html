<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Транзакции - Expense Tracker</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="dashboard-container">
  <!-- Sidebar -->
  <div th:replace="~{user/fragments/sidebar :: sidebar(activePage='transactions')}"></div>

  <!-- Main Content -->
  <main class="main-content">
    <header class="content-header">
      <div class="header-left">
        <h1>Транзакции</h1>
        <p class="welcome-message">Управление всеми вашими доходами и расходами</p>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" onclick="showAddTransactionModal()">
          <i class="fas fa-plus"></i> Добавить транзакцию
        </button>
      </div>
    </header>

    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success" style="margin: 1rem 2rem;">
      <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
    </div>
    
    <div th:if="${error}" class="alert alert-error" style="margin: 1rem 2rem;">
      <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
    </div>

    <!-- Filters -->
    <div class="card" style="margin: 1rem 2rem;">
      <div class="card-header">
        <h3>Фильтры</h3>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem;">
        <div class="form-group" style="margin-bottom: 0;">
          <label>Тип</label>
          <select id="filterType" class="form-control">
            <option value="">Все</option>
            <option value="INCOME">Доходы</option>
            <option value="EXPENSE">Расходы</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>Категория</label>
          <select id="filterCategory" class="form-control">
            <option value="">Все категории</option>
            <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>От</label>
          <input type="date" id="filterDateFrom" class="form-control">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label>До</label>
          <input type="date" id="filterDateTo" class="form-control">
        </div>
        <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
          <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fas fa-filter"></i> Применить
          </button>
        </div>
      </div>
    </div>

    <!-- Transactions Table -->
    <div class="transactions-table" style="margin: 1rem 2rem;">
      <table>
        <thead>
          <tr>
            <th>Дата</th>
            <th>Тип</th>
            <th>Категория</th>
            <th>Описание</th>
            <th>Сумма</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="transaction : ${transactions}">
            <td th:text="${#temporals.format(transaction.date, 'dd.MM.yyyy')}">01.01.2024</td>
            <td>
              <span th:classappend="${transaction.type == 'INCOME' ? 'type-income' : 'type-expense'}"
                    th:text="${transaction.type == 'INCOME' ? 'Доход' : 'Расход'}">
                Расход
              </span>
            </td>
            <td>
              <span th:if="${transaction.category}" 
                    class="category-badge"
                    th:style="'background-color: ' + ${transaction.category.color} + ';'"
                    th:text="${transaction.category.name}">Продукты</span>
              <span th:unless="${transaction.category}" class="category-badge" style="background-color: #95a5a6;">
                Без категории
              </span>
            </td>
            <td th:text="${transaction.description ?: '-'}">Покупка продуктов</td>
            <td th:classappend="${transaction.type == 'INCOME' ? 'income' : 'expense'}"
                th:text="${T(com.expensetracker.util.MoneyFormatter).formatWithAbbreviation(transaction.amount)}">₽1,500</td>
            <td>
              <form th:action="@{/user/transactions/{id}/delete(id=${transaction.id})}" method="post" style="display: inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn-icon" title="Удалить" onclick="return confirm('Вы уверены, что хотите удалить эту транзакцию?');">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          <tr th:unless="${transactions?.size() > 0}">
            <td colspan="6" class="empty-state">
              <i class="fas fa-receipt"></i>
              <p>Пока нет транзакций. Добавьте первую!</p>
              <button class="btn btn-primary" onclick="showAddTransactionModal()">
                <i class="fas fa-plus"></i> Добавить транзакцию
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- Add Transaction Modal -->
<div class="modal" id="addTransactionModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Добавить транзакцию</h3>
      <button class="modal-close" onclick="closeAddTransactionModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="addTransactionForm" method="post" action="/user/transactions/add" th:action="@{/user/transactions/add}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="form-group">
          <label for="amount">Сумма *</label>
          <input type="number" id="amount" name="amount" step="0.01" min="0.01" required>
        </div>
        <div class="form-group">
          <label for="type">Тип *</label>
          <select id="type" name="type" required>
            <option value="">Выберите тип</option>
            <option value="INCOME">Доход</option>
            <option value="EXPENSE">Расход</option>
          </select>
        </div>
        <div class="form-group">
          <label for="categoryId">Категория</label>
          <select id="categoryId" name="categoryId">
            <option value="">Без категории</option>
            <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
          </select>
        </div>
        <div class="form-group">
          <label for="description">Описание</label>
          <textarea id="description" name="description" rows="3" placeholder="Описание транзакции"></textarea>
        </div>
        <div class="form-group">
          <label for="date">Дата *</label>
          <input type="date" id="date" name="date" th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}" required>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddTransactionModal()">
            Отмена
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i> Добавить
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="/js/app.js"></script>
<script>
  function showAddTransactionModal() {
    const modal = document.getElementById('addTransactionModal');
    if (modal) {
      modal.classList.add('active');
      const dateInput = document.getElementById('date');
      if (dateInput && !dateInput.value) {
        dateInput.valueAsDate = new Date();
      }
    }
  }

  function closeAddTransactionModal() {
    const modal = document.getElementById('addTransactionModal');
    if (modal) {
      modal.classList.remove('active');
      const form = document.getElementById('addTransactionForm');
      if (form) {
        form.reset();
      }
    }
  }

  window.onclick = function(event) {
    const modal = document.getElementById('addTransactionModal');
    if (event.target === modal) {
      closeAddTransactionModal();
    }
  }

  function applyFilters() {
    // Простая фильтрация на клиенте (можно улучшить через сервер)
    const type = document.getElementById('filterType').value;
    const category = document.getElementById('filterCategory').value;
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;
    
    // Здесь можно добавить AJAX запрос для фильтрации на сервере
    console.log('Фильтры:', {type, category, dateFrom, dateTo});
  }
</script>
</body>
</html>

